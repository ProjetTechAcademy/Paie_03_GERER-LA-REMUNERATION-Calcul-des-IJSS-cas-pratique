<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>03_GÉRER LES HS & DIMANCHE / règles 2025 / cas pratique</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Inter',sans-serif;background:#F8F7F4;color:#3D405B}
    .nav-link{transition:all .3s;border-bottom:2px solid transparent}
    .nav-link:hover,.nav-link.active{color:#81B29A;border-bottom-color:#81B29A}
    .card{background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,.05);transition:transform .3s, box-shadow .3s}
    .card:hover{transform:translateY(-5px);box-shadow:0 10px 15px rgba(0,0,0,.07)}
    input,select{border-color:#E0E0E0}
    input:focus,select:focus{border-color:#81B29A;box-shadow:0 0 0 2px rgba(129,178,154,.3);outline:none}
    .table-header{background:#F3F4F6}
  </style>
</head>
<body class="antialiased">
  <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-50 shadow-sm">
    <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center">
          <span class="font-bold text-lg text-gray-800">03_GÉRER LES HEURES SUP & DIMANCHE</span>
        </div>
        <div class="hidden md:block">
          <div class="ml-10 flex items-baseline space-x-4">
            <a href="#processus" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700">Processus</a>
            <a href="#regles" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700">Règles 2025</a>
            <a href="#simulateur" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700">Simulateur</a>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
    <div class="text-center mb-12">
      <h1 class="text-3xl md:text-4xl font-bold tracking-tight text-gray-900">Heures supplémentaires & travail du dimanche</h1>
      <p class="mt-4 text-lg text-gray-600 max-w-3xl mx-auto">Un parcours pédagogique + un calculateur interactif, calés sur l’actualité réglementaire 2025 (France) : décompte hebdo, majorations, exonérations salariales (11,31 %), déduction patronale, non-imposition jusqu’à 7 500 € et règles « dimanche » par convention.</p>
    </div>

    <!-- 1. Processus -->
    <section id="processus" class="mb-16 scroll-mt-20">
      <div class="card p-6 md:p-8">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">🔁 Le Processus de décompte</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
          <div class="p-4 bg-blue-100 rounded-lg border border-blue-200">
            <p class="font-bold text-blue-800 text-5xl">1</p>
            <h3 class="font-semibold text-blue-800 mt-2">Semaine civile</h3>
            <p class="text-sm text-blue-700 mt-2">Les HS se décomptent par semaine (lun 0h → dim 24h, sauf accord). Le constat se fait <strong>à la fin</strong> de la semaine, y compris si elle chevauche 2 mois.</p>
          </div>
          <div class="p-4 bg-yellow-100 rounded-lg border border-yellow-200">
            <p class="font-bold text-yellow-800 text-5xl">2</p>
            <h3 class="font-semibold text-yellow-800 mt-2">Taux de majoration</h3>
            <p class="text-sm text-yellow-700 mt-2">Par défaut : +25 % de la 36e à la 43e heure (8 HS), puis +50 % au-delà. Un accord/CCN peut prévoir d’autres taux.</p>
          </div>
          <div class="p-4 bg-green-100 rounded-lg border border-green-200">
            <p class="font-bold text-green-800 text-5xl">3</p>
            <h3 class="font-semibold text-green-800 mt-2">Dimanche</h3>
            <p class="text-sm text-green-700 mt-2">Pas de prime légale systématique : tout dépend de la CCN / accord / usage. Certaines prévoient +100 % et repos compensateur.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- 2. Règles 2025 -->
    <section id="regles" class="mb-16 scroll-mt-20">
      <div class="card p-6 md:p-8">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">📜 Règles sociales & fiscales 2025 (synthèse)</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="p-4 rounded-lg border bg-white">
            <h3 class="font-semibold">Exonération salariale (HS/HC)</h3>
            <ul class="list-disc list-inside text-sm text-gray-700 mt-2">
              <li>Réduction de cotisations salariales sur HS/HC dans la limite de <strong>11,31 %</strong>.</li>
              <li>Applicable sur la rémunération + majorations (dans la limite des taux légaux ou conventionnels).</li>
            </ul>
          </div>
          <div class="p-4 rounded-lg border bg-white">
            <h3 class="font-semibold">Déduction patronale (HS)</h3>
            <ul class="list-disc list-inside text-sm text-gray-700 mt-2">
              <li><strong>&lt; 20</strong> salariés : <strong>1,50 €</strong> par HS.</li>
              <li><strong>20 à 249</strong> salariés : <strong>0,50 €</strong> par HS.</li>
            </ul>
          </div>
          <div class="p-4 rounded-lg border bg-white">
            <h3 class="font-semibold">Impôt sur le revenu</h3>
            <ul class="list-disc list-inside text-sm text-gray-700 mt-2">
              <li>HS exonérées d’IR <strong>jusqu’à 7 500 € nets</strong>/an (déclarées quand même).</li>
            </ul>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
          <div>
            <h4 class="font-semibold text-lg">Quelles primes compter pour majorer les HS ?</h4>
            <p class="text-sm text-gray-700 mt-2">Inclure les éléments liés à l’exécution/conditions du travail (ex : prime de rendement individuel/collectif contributive, prime de dimanche/jours fériés, nuit, insalubrité…). Exclure les éléments déconnectés (13e mois, fin d’année, transport/panier remboursements, évènements familiaux…).</p>
          </div>
          <div>
            <h4 class="font-semibold text-lg">Travail du dimanche : points de vigilance</h4>
            <p class="text-sm text-gray-700 mt-2">Dérogations sectorielles/géographiques, volontariat selon cas, repos compensateur éventuel, non-cumul ou cumul des majorations (HS × Dimanche) selon CCN/jurisprudence.</p>
          </div>
        </div></div></section>

<!-- 2.b Détail des éléments inclus/exclus dans la base HS (pédagogique) -->
<section id="base-hs-detail" class="mb-16 scroll-mt-20">
  <div class="card p-6 md:p-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">🧩 Ce qui <span class="underline">rentre</span> (ou pas) dans la base de calcul des HS</h2>
    <p class="text-sm text-gray-600 mb-4">Synthèse issue de ta documentation (inclure/exclure par défaut, hors dispositions conventionnelles plus favorables). Exemples saillants : <strong>rendent</strong> : primes de productivité/rendement individuel, polyvalence, conditions de travail (nuit, insalubrité, froid, astreinte…), travail du dimanche/jours fériés. <strong>Ne rendent pas</strong> : ancienneté, 13e mois/fin d’année, événements familiaux, transport/panier/déplacement, primes liées aux résultats globaux/participation/intéressement, primes CE. fileciteturn1file0</p>
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white border text-sm">
        <thead class="table-header">
          <tr>
            <th class="py-2 px-3 text-left">Catégorie</th>
            <th class="py-2 px-3 text-left">Exemples</th>
            <th class="py-2 px-3 text-left">Prise en compte base HS</th>
            <th class="py-2 px-3 text-left">Notes</th>
          </tr>
        </thead>
        <tbody>
          <tr class="border-b"><td class="py-2 px-3">Exécution du travail</td><td class="py-2 px-3">Rendement / productivité <em>individuelle</em>, polyvalence, commissions</td><td class="py-2 px-3 font-semibold text-green-700">Oui</td><td class="py-2 px-3 text-gray-600">Directement liées au travail fourni. Commissions : assimilées à salaire variable.</td></tr>
          <tr class="border-b"><td class="py-2 px-3">Conditions de travail</td><td class="py-2 px-3">Nuit, astreinte, insalubrité, froid, salissure, danger/risque, situation géographique, dimanche, jours fériés</td><td class="py-2 px-3 font-semibold text-green-700">Oui</td><td class="py-2 px-3 text-gray-600">Primes inhérentes à la nature du travail. fileciteturn1file3</td></tr>
          <tr class="border-b"><td class="py-2 px-3">Lieu / frais</td><td class="py-2 px-3">Transport, panier, déplacement, mutation</td><td class="py-2 px-3 font-semibold text-red-700">Non</td><td class="py-2 px-3 text-gray-600">Remboursements de frais (hors élément permanent de salaire). fileciteturn1file3</td></tr>
          <tr class="border-b"><td class="py-2 px-3">Primes générales</td><td class="py-2 px-3">13e mois, fin d’année, vacances, responsabilité</td><td class="py-2 px-3 font-semibold text-red-700">Non</td><td class="py-2 px-3 text-gray-600">Non liées à la prestation directe. fileciteturn1file0</td></tr>
          <tr class="border-b"><td class="py-2 px-3">Situation personnelle</td><td class="py-2 px-3">Mariage, naissance, médaille du travail</td><td class="py-2 px-3 font-semibold text-red-700">Non</td><td class="py-2 px-3 text-gray-600">Évènements personnels. fileciteturn1file3</td></tr>
          <tr class="border-b"><td class="py-2 px-3">Situation de l’entreprise</td><td class="py-2 px-3">Bilan, résultat, participation, intéressement, productivité <em>collective</em></td><td class="py-2 px-3 font-semibold text-red-700">Non</td><td class="py-2 px-3 text-gray-600">Dépendent de la performance globale. fileciteturn1file3</td></tr>
          <tr><td class="py-2 px-3">Assiduité</td><td class="py-2 px-3">Prime d’assiduité</td><td class="py-2 px-3 font-semibold text-amber-700">Cas par cas</td><td class="py-2 px-3 text-gray-600">Jurisprudence vs administration : paramétrable dans le simulateur. fileciteturn1file0</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- 3. Simulateur -->
    <section id="simulateur" class="mb-16 scroll-mt-20">
      <div class="card p-6 md:p-8">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">🖥️ Simulateur Heures Sup & Dimanche (2025)</h2>

        <!-- 3.1 Paramètres entreprise & salarié -->
        <div class="bg-gray-50 p-6 rounded-lg border mb-8">
          <h3 class="text-xl font-semibold mb-4 text-gray-700">1. Paramètres</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">Effectif entreprise</label>
              <select id="effectif" class="mt-1 block w-full rounded-md p-2">
                <option value="-20">&lt; 20</option>
                <option value="20-249">20 à 249</option>
                <option value=">=250">≥ 250 (pas de déduction patronale)</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Salaire de base mensuel (€)</label>
              <input id="salaireBase" type="number" step="0.01" value="2500" class="mt-1 block w-full rounded-md p-2">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Heures de base mensuelles</label>
              <input id="heuresBaseMensuelles" type="number" value="151.67" class="mt-1 block w-full rounded-md p-2">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">(Option rapide) Montant de primes à inclure (€)</label>
              <input id="primesIncluses" type="number" step="0.01" value="0" class="mt-1 block w-full rounded-md p-2">
            </div>
            <div class="lg:col-span-2">
              <label class="block text-sm font-medium text-gray-700">Règle dimanche (CCN)</label>
              <select id="regleDimanche" class="mt-1 block w-full rounded-md p-2">
                <option value="aucune">Générique (pas de prime légale)</option>
                <option value="+100">CCN avec majoration 100 % (ex : Négoce Ameublement)</option>
                <option value="syntec100">SYNTEC : +100 % (travail exceptionnel du dimanche) + HS éventuellement cumulables</option>
                <option value="noncumul90">CCN non-cumul (appliquer la majoration la plus favorable)</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Cumul HS × Dimanche</label>
              <select id="cumul" class="mt-1 block w-full rounded-md p-2">
                <option value="non">Non (prendre la majoration la plus favorable)</option>
                <option value="oui">Oui (additionner)</option>
              </select>
            </div>
            <div class="flex items-end">
              <label class="flex items-center text-sm">
                <input id="reposComp" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600"> 
                <span class="ml-2">Repos comp. dimanche (si CCN le prévoit)</span>
              </label>
            </div>
          </div>
        </div>

        <!-- 1.b FOULE des éléments de rémunération (on imagine tout, on choisit ce qui rentre) -->
        <div class="bg-white p-6 rounded-lg border mb-8">
          <h3 class="text-xl font-semibold mb-2 text-gray-700">1.b Éléments de rémunération – ce qui <em>rentre</em> dans la base HS</h3>
          <p class="text-xs text-gray-600 mb-4">Coche les éléments présents et saisis leurs montants mensuels. Le simulateur n’additionne dans la base HS que ceux réputés <strong>inclus</strong> (ou « cas par cas » si tu actives l’option). Références issues de ta fiche « Rémunération pour calcul HS ». fileciteturn1file0</p>
          <div class="flex items-center gap-3 mb-3">
            <label class="flex items-center text-sm"><input id="inclureAssiduite" type="checkbox" class="mr-2">Inclure la prime d’assiduité (cas par cas)</label>
          </div>
          <div id="foulePrimes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          <div class="mt-4 text-sm">
            <span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full mr-2">Total des éléments <strong>INCLUS</strong> pris en base HS : <span id="totalPrimesIncluses" class="font-bold">0,00 €</span></span>
            <span class="inline-block bg-gray-100 text-gray-800 px-3 py-1 rounded-full">Total des éléments <strong>EXCLUS</strong> (hors base HS) : <span id="totalPrimesExclues" class="font-bold">0,00 €</span></span>
          </div>
        </div>
          <h3 class="text-xl font-semibold mb-4 text-gray-700">2. Heures réalisées (4 semaines type)</h3>
          <div id="semaines" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
          <p class="text-xs text-gray-500 mt-4">💡 Les HS se décomptent <strong>par semaine</strong>. Le simulateur applique +25 % jusqu’à 8 HS (36e→43e h) puis +50 % au-delà, sauf si vos règles/CCN diffèrent.</p>
        </div>

        <!-- 3.3 Résultats -->
        <div>
          <h3 class="text-xl font-semibold mb-4 text-gray-700">3. Résultats & bulletin simplifié</h3>
          <div id="resultats" class="space-y-6"></div>
          <div id="explications" class="space-y-4 mt-6">
            <div class="p-4 rounded-lg border bg-blue-50 border-blue-200">
              <h5 class="font-semibold text-blue-800 mb-2">🔎 Déduction forfaitaire patronale – explication & exemple</h5>
              <p class="text-sm text-blue-900">Pour chaque heure supplémentaire payée, l’employeur déduit un forfait de cotisations patronales : <strong>1,50 €</strong> si l’effectif &lt; 20, <strong>0,50 €</strong> si 20–249, <strong>0</strong> si ≥ 250. Cette déduction n’impacte pas le brut/net du salarié ; elle minore le coût employeur (souvent visible en paie sous une ligne « Déduction forfaitaire HS » côté cotisations patronales).</p>
              <p class="text-sm text-blue-900 mt-2">Exemple : 12 HS dans le mois et effectif « 20–249 » ⇒ 12 × 0,50 € = <strong>6,00 €</strong> de cotisations patronales en moins. Avec « &lt; 20 », ce serait 12 × 1,50 € = <strong>18,00 €</strong>.</p>
              <p class="text-xs text-blue-900 mt-1">Le simulateur calcule et affiche cette déduction dans le bloc « Côté employeur ».</p>
            </div>
            <div class="p-4 rounded-lg border bg-white">
              <h5 class="font-semibold text-gray-800 mb-2">🧾 Visualisation sur le bulletin</h5>
              <ul class="list-disc list-inside text-sm text-gray-700">
                <li><strong>Brut</strong> : Salaire de base + <em>Heures sup 25 %</em> + <em>Heures sup 50 %</em> + éventuelle <em>Prime dimanche</em> + ajustement non‑cumul.</li>
                <li><strong>Base HS</strong> utilisée pour le taux : <em>taux horaire</em> = (Salaire de base + <span class="underline">éléments inclus</span>) / heures mensuelles. Un tableau « Détail base HS » est affiché ci‑dessous.</li>
                <li><strong>Réduction salariale 11,31 %</strong> : ajoutée au net (dans la limite des cotisations dues) – affichée à part.</li>
                <li><strong>Déduction forfaitaire patronale</strong> : affichée côté employeur (pas dans le net à payer).</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const inputs = {
      effectif: document.getElementById('effectif'),
      salaireBase: document.getElementById('salaireBase'),
      heuresBaseMensuelles: document.getElementById('heuresBaseMensuelles'),
      primesIncluses: document.getElementById('primesIncluses'),
      regleDimanche: document.getElementById('regleDimanche'),
      cumul: document.getElementById('cumul'),
      reposComp: document.getElementById('reposComp'),
      inclureAssiduite: document.getElementById('inclureAssiduite')
    };

    // Modèle des éléments (foule) – label, clé, inclusParDefaut, note
    const FOULE = [
      {k:'commissions', label:'Commissions (vente/CA)', inclut:true, note:'Composante variable liée à l’exécution'},
      {k:'rendement_ind', label:'Prime de rendement / productivité individuelle', inclut:true, note:'Oui (liée au travail fourni) fileciteturn1file0'},
      {k:'polyvalence', label:'Prime de polyvalence', inclut:true, note:'Oui fileciteturn1file0'},
      {k:'nuit', label:'Prime de nuit', inclut:true, note:'Oui (conditions de travail) fileciteturn1file3'},
      {k:'astreinte', label:'Astreinte', inclut:true, note:'Oui fileciteturn1file3'},
      {k:'insalubrite', label:'Insalubrité / salissure / froid / risque', inclut:true, note:'Oui (conditions de travail) fileciteturn1file3'},
      {k:'geo', label:'Situation géographique (chantier, etc.)', inclut:true, note:'Oui (inhérent au poste) fileciteturn1file3'},
      {k:'dimanche', label:'Prime travail du dimanche', inclut:true, note:'Oui (conditions de travail) fileciteturn1file3'},
      {k:'jf', label:'Prime jours fériés', inclut:true, note:'Oui fileciteturn1file3'},
      {k:'assiduite', label:'Prime d’assiduité', inclut:false, note:'Cas par cas (option en haut) fileciteturn1file0'},
      {k:'anciennete', label:'Prime d’ancienneté', inclut:false, note:'Non fileciteturn1file0'},
      {k:'13e', label:'13e mois / fin d’année / vacances', inclut:false, note:'Non fileciteturn1file0'},
      {k:'responsabilite', label:'Prime de responsabilité / sécurité', inclut:false, note:'Non fileciteturn1file0'},
      {k:'transport', label:'Transport / panier / déplacement', inclut:false, note:'Non (frais) fileciteturn1file3'},
      {k:'evenement', label:'Événements familiaux / médaille', inclut:false, note:'Non fileciteturn1file3'},
      {k:'participation', label:'Participation / intéressement', inclut:false, note:'Non fileciteturn1file3'},
      {k:'resultat', label:'Primes de résultat / bilan / productivité collective', inclut:false, note:'Non (performance globale) fileciteturn1file3'}
    ];

    // Render "foule" UI
    const fouleDiv = document.getElementById('foulePrimes');
    const champsFoule = {};
    FOULE.forEach(item => {
      const card = document.createElement('div');
      card.className = 'p-3 rounded-lg border bg-white';
      card.innerHTML = `
        <label class="flex items-start gap-2">
          <input type="checkbox" data-k="${item.k}" ${item.inclut?'checked':''} class="mt-1 h-4 w-4 rounded border-gray-300 text-indigo-600">
          <div class="w-full">
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium text-gray-800">${item.label}</span>
              <span class="text-xs ${item.inclut?'text-green-700':'text-red-700'}">${item.inclut?'INCLUS':'EXCLU'}</span>
            </div>
            <p class="text-xs text-gray-500 mt-1">${item.note}</p>
            <div class="mt-2">
              <label class="text-xs text-gray-600">Montant mensuel (€)</label>
              <input type="number" step="0.01" data-kv="${item.k}" value="0" class="mt-1 block w-full rounded-md p-2 border" />
            </div>
          </div>
        </label>`;
      fouleDiv.appendChild(card);
      champsFoule[item.k] = {
        chk: card.querySelector(`input[type=checkbox][data-k="${item.k}"]`),
        val: card.querySelector(`input[type=number][data-kv="${item.k}"]`),
        meta: item
      };
    });

    // Constantes 2025 vérifiées (SMIC utile pour repères uniquement)
    const SMIC_HORAIRE_2025 = 11.88; // Insee 2025
    const REDUCTION_SALARIALE_MAX = 0.1131; // plafond 11,31%
    const DEDUC_PATRONALE_LT20 = 1.50; // €/HS
    const DEDUC_PATRONALE_20_249 = 0.50; // €/HS

    // Construction des 4 semaines de saisie
    const semainesDiv = document.getElementById('semaines');
    const totalPrimesInclusesSpan = document.getElementById('totalPrimesIncluses');
    const totalPrimesExcluesSpan = document.getElementById('totalPrimesExclues');
    const semaines = [];
    for (let s = 1; s <= 4; s++) {
      const wrap = document.createElement('div');
      wrap.className = 'card p-4';
      wrap.innerHTML = `
        <h4 class="font-semibold text-gray-800 mb-3">Semaine ${s}</h4>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700">Heures totales réalisées</label>
            <input data-k="heures" type="number" step="0.01" value="35" class="mt-1 block w-full rounded-md p-2">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Dont le dimanche</label>
            <input data-k="dimanche" type="number" step="0.01" value="0" class="mt-1 block w-full rounded-md p-2">
          </div>
        </div>`;
      semainesDiv.appendChild(wrap);
      const heures = wrap.querySelector('input[data-k="heures"]');
      const dimanche = wrap.querySelector('input[data-k="dimanche"]');
      semaines.push({ heures, dimanche });
    }

    const resultatsDiv = document.getElementById('resultats');

    // Listeners
    Object.values(inputs).forEach(el => el.addEventListener('input', recalc));
    semaines.forEach(s => {
      s.heures.addEventListener('input', recalc);
      s.dimanche.addEventListener('input', recalc);
    });
    // Listeners foule
    Object.values(champsFoule).forEach(({chk,val})=>{ chk.addEventListener('input', recalc); val.addEventListener('input', recalc); });
    inputs.inclureAssiduite.addEventListener('input', recalc);

    function arr2(n){return Math.round(n*100)/100}

    function recalc(){
      const salaireBase = parseFloat(inputs.salaireBase.value||0);
      const heuresBaseMensuelles = parseFloat(inputs.heuresBaseMensuelles.value||151.67);

      // Calcul précis de la base HS à partir de la foule (avec option assiduité)
      let totalInclus = 0, totalExclus = 0;
      Object.values(champsFoule).forEach(({chk,val,meta})=>{
        const m = parseFloat(val.value||0);
        const estAssiduite = meta.k==='assiduite';
        const doitInclure = meta.inclut || (estAssiduite && inputs.inclureAssiduite.checked);
        if (m>0){ if (doitInclure) totalInclus += m; else totalExclus += m; }
      });
      // Option rapide d’ajout manuel si besoin
      const primesRapides = parseFloat(inputs.primesIncluses.value||0);
      totalInclus += primesRapides;

      const tauxHoraireBase = (salaireBase + totalInclus) / heuresBaseMensuelles;
      totalPrimesInclusesSpan.textContent = `${(Math.round(totalInclus*100)/100).toFixed(2)} €`;
      totalPrimesExcluesSpan.textContent = `${(Math.round(totalExclus*100)/100).toFixed(2)} €`;

      const effectifVal = inputs.effectif.value;
      const regleDim = inputs.regleDimanche.value;
      const cumul = inputs.cumul.value === 'oui';

      // Déduction patronale par HS selon effectif
      const deducPatronaleParHS = effectifVal === '-20' ? DEDUC_PATRONALE_LT20 : (effectifVal === '20-249' ? DEDUC_PATRONALE_20_249 : 0);

      // Boucle semaines => calc HS par semaine
      let totalHS25 = 0, totalHS50 = 0, totalDimHeures = 0;
      let remunerationDimanche = 0; // hors HS, prime dimanche/CCN

      semaines.forEach(({heures, dimanche}) => {
        const h = parseFloat(heures.value||0);
        const d = parseFloat(dimanche.value||0);
        const hebdoBase = 35; // supposé; adapter si accord différent
        const hsSemaine = Math.max(0, h - hebdoBase);
        const hs25 = Math.min(8, hsSemaine);
        const hs50 = Math.max(0, hsSemaine - 8);
        totalHS25 += hs25; totalHS50 += hs50; totalDimHeures += d;

        // Règle dimanche (hors HS) => si cumul=false on prendra le mieux plus loin
        let primeDimanche = 0;
        if (regleDim === '+100' || regleDim === 'syntec100') {
          primeDimanche = d * tauxHoraireBase; // +100% => doublement => prime = base en plus
        } else if (regleDim === 'aucune' || regleDim === 'noncumul90') {
          primeDimanche = 0; // générique
        }
        remunerationDimanche += primeDimanche;
      });

      // Heures sup rémunération et majorations
      const baseHS = tauxHoraireBase; // inclut les éléments réputés inclus (foule + option rapide)
      const remunHS25 = totalHS25 * baseHS * 1.25;
      const remunHS50 = totalHS50 * baseHS * 1.50;
      const majHS = (totalHS25 * baseHS * 0.25) + (totalHS50 * baseHS * 0.50);
      const remunHSBrut = remunHS25 + remunHS50; // base+majorations

      // Dimanche vs HS : gestion du cumul
      // Si pas de cumul et CCN prévoit majoration dimanche, on compare pour les heures faites un dimanche ET heures sup
      // Approche simple : appliquer non-cumul en remplaçant, pour min(totalDimHeures, totalHS), la majoration HS par la majoration dimanche si elle est supérieure.
      let ajustementNonCumul = 0;
      if (!cumul && (inputs.regleDimanche.value === '+100' || inputs.regleDimanche.value === 'noncumul90')) {
        const totalHS = totalHS25 + totalHS50;
        const chevauchement = Math.min(totalDimHeures, totalHS);
        const majorationDim = baseHS; // +100% => prime = 100% du taux (en plus du salaire de base)
        // Majorations HS moyennes pondérées sur chevauchement : approx en prenant 25% sur les 8 premières puis 50%
        const majChev25 = Math.min(chevauchement, totalHS25) * baseHS * 0.25;
        const majChev50 = Math.max(0, chevauchement - totalHS25) * baseHS * 0.50;
        const majHSsurChev = majChev25 + majChev50;
        // Si la majoration dimanche est plus favorable, on remplace la majoration HS par celle de dimanche sur les heures qui se chevauchent
        ajustementNonCumul = Math.max(0, (chevauchement * majorationDim) - majHSsurChev);
      }

      // Rémunération brute
      const salaireBrutBase = salaireBase;
      const brutHS = remunHSBrut; // comprend base des HS
      const brutDimanche = remunerationDimanche; // prime dim. hors HS (ou ajustée via non-cumul)
      const brutTotal = salaireBrutBase + brutHS + brutDimanche + ajustementNonCumul;

      // Réduction salariale HS (11,31% max) – n’agit que sur la partie HS/HC (rémunération et majoration dans la limite)
      const assietteRedSalHS = remunHSBrut + (cumul ? remunerationDimanche : (remunerationDimanche + ajustementNonCumul));
      const reducSalariale = assietteRedSalHS * REDUCTION_SALARIALE_MAX;

      // Déduction forfaitaire patronale
      const nbHS = totalHS25 + totalHS50;
      const deducPatronale = nbHS * deducPatronaleParHS;

      // Net (approche pédagogique) : on applique 22% de charges salariales sur le brut, puis on retranche la réduction salariale calculée
      const netAvantHS = salaireBrutBase * 0.78; // approx 22%
      const netHS = (brutHS + brutDimanche + ajustementNonCumul) * 0.78;
      const netApresReduc = netAvantHS + netHS + reducSalariale; // la réduction augmente le net

      // Sortie
      resultatsDiv.innerHTML = '';

      const blocSynthese = `
        <div class="p-4 rounded-lg border bg-gray-100">
          <h4 class="font-bold text-lg text-indigo-700 mb-4">Synthèse mois (pédagogique)</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <table class="min-w-full bg-white border text-sm">
                <tbody>
                  <tr class="border-b"><td class="py-1 px-2">Taux horaire de base (avec éléments INCLUS)</td><td class="text-right py-1 px-2">${arr2(baseHS).toFixed(2)} €</td></tr>
                  <tr class="border-b"><td class="py-1 px-2">HS à 25 %</td><td class="text-right py-1 px-2">${totalHS25} h</td></tr>
                  <tr class="border-b"><td class="py-1 px-2">HS à 50 %</td><td class="text-right py-1 px-2">${totalHS50} h</td></tr>
                  <tr class="border-b"><td class="py-1 px-2">Heures travaillées le dimanche</td><td class="text-right py-1 px-2">${arr2(totalDimHeures)} h</td></tr>
                </tbody>
              </table>
            </div>
            <div>
              <table class="min-w-full bg-white border text-sm">
                <tbody>
                  <tr class="border-b"><td class="py-1 px-2">Rémunération HS (base + maj.)</td><td class="text-right py-1 px-2">${arr2(brutHS).toFixed(2)} €</td></tr>
                  <tr class="border-b"><td class="py-1 px-2">Prime dimanche</td><td class="text-right py-1 px-2">${arr2(brutDimanche).toFixed(2)} €</td></tr>
                  ${!cumul && (inputs.regleDimanche.value === '+100' || inputs.regleDimanche.value === 'noncumul90') ? `<tr class=\"border-b\"><td class=\"py-1 px-2\">Ajustement non-cumul (plus favorable)</td><td class=\"text-right py-1 px-2\">${arr2(ajustementNonCumul).toFixed(2)} €</td></tr>`:''}
                  <tr class="border-b font-semibold"><td class="py-1 px-2">Brut total</td><td class="text-right py-1 px-2">${arr2(brutTotal).toFixed(2)} €</td></tr>
                </tbody>
              </table>
            </div>
            <div>
              <table class="min-w-full bg-white border text-sm">
                <thead class="table-header"><tr><th class="py-2 px-2 text-left">Détail base HS</th><th class="py-2 px-2 text-right">€</th></tr></thead>
                <tbody>
                  <tr class="border-b"><td class="py-1 px-2">Salaire de base</td><td class="text-right py-1 px-2">${arr2(salaireBrutBase).toFixed(2)}</td></tr>
                  <tr class="border-b"><td class="py-1 px-2">Éléments INCLUS (foule)</td><td class="text-right py-1 px-2">${(Math.round((totalInclus-primesRapides)*100)/100).toFixed(2)}</td></tr>
                  <tr class="border-b"><td class="py-1 px-2">Ajout manuel (option rapide)</td><td class="text-right py-1 px-2">${arr2(primesRapides).toFixed(2)}</td></tr>
                  <tr class="bg-gray-200 font-bold"><td class="py-1 px-2">Total pris en base HS</td><td class="text-right py-1 px-2">${(Math.round((salaireBrutBase+totalInclus)*100)/100).toFixed(2)}</td></tr>
                  <tr class="text-xs"><td class="py-1 px-2 text-gray-500" colspan="2">Éléments EXCLUS (frais, 13e mois, participation, etc.) : ${arr2(totalExclus).toFixed(2)} € (hors base HS).</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>`;

      const blocBulletin = `
        <div class="p-4 rounded-lg border bg-white">
          <h5 class="font-semibold text-gray-800 mb-2">🧾 Bulletin simplifié</h5>
          <table class="min-w-full bg-white border text-sm">
            <tbody>
              <tr class="border-b"><td class="py-1 px-2">Salaire de base</td><td class="text-right py-1 px-2">${arr2(salaireBrutBase).toFixed(2)} €</td></tr>
              <tr class="border-b"><td class="py-1 px-2">Heures sup 25 %</td><td class="text-right py-1 px-2">${arr2(totalHS25*baseHS*1.25).toFixed(2)} €</td></tr>
              <tr class="border-b"><td class="py-1 px-2">Heures sup 50 %</td><td class="text-right py-1 px-2">${arr2(totalHS50*baseHS*1.50).toFixed(2)} €</td></tr>
              <tr class="border-b"><td class="py-1 px-2">Prime dimanche</td><td class="text-right py-1 px-2">${arr2(brutDimanche).toFixed(2)} €</td></tr>
              ${!cumul && (inputs.regleDimanche.value === '+100' || inputs.regleDimanche.value === 'noncumul90') ? `<tr class=\"border-b\"><td class=\"py-1 px-2\">Ajustement non-cumul</td><td class=\"text-right py-1 px-2\">${arr2(ajustementNonCumul).toFixed(2)} €</td></tr>`:''}
              <tr class="bg-gray-200 font-bold"><td class="py-1 px-2">Brut soumis</td><td class="text-right py-1 px-2">${arr2(brutTotal).toFixed(2)} €</td></tr>
              <tr><td class="py-1 px-2 text-xs italic text-gray-500" colspan="2">… Cotisations salariales (≈22 %) …</td></tr>
              <tr class="border-t"><td class="py-1 px-2">Réduction salariale HS (max 11,31 %)</td><td class="text-right py-1 px-2">+${arr2(reducSalariale).toFixed(2)} €</td></tr>
              <tr class="border-t font-medium"><td class="py-1 px-2">Net à payer (approx.)</td><td class="text-right py-1 px-2">${arr2(netApresReduc).toFixed(2)} €</td></tr>
            </tbody>
          </table>
        </div>`;

      const blocCotisations = `
        <div class="p-4 rounded-lg border bg-blue-50 border-blue-200">
          <h5 class="font-semibold text-blue-800 mb-2">💼 Côté employeur</h5>
          <p class="text-sm text-blue-900">Déduction forfaitaire patronale estimée : <strong>${nbHS}</strong> HS × ${deducPatronaleParHS.toFixed(2)} € = <strong>${arr2(deducPatronale).toFixed(2)} €</strong>.</p>
          ${inputs.reposComp.checked ? '<p class="text-xs text-blue-900 mt-1">Repos compensateur dimanche : à organiser selon la CCN/accord (affichage non chiffré).</p>' : ''}
        </div>`;

      resultatsDiv.innerHTML = blocSynthese + blocBulletin + blocCotisations;
    }

    recalc();
  });
  </script>
</body>
</html>
